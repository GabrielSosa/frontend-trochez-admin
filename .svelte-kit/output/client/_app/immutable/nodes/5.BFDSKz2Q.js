import{S as oe,i as ae,s as ne,m as se,o as ie,d as p,p as z,q as R,r as G,u as ce,b as N,v as q,c as h,w as d,e as j,f as C,x as W,h as V,y as x,j as T,z as J,k as P,A as fe,B as de,a as M,C as K,g as L,t as U,D as ue,E as F,F as H,G as Q}from"../chunks/CnbjcvQe.js";import{N as me,e as X}from"../chunks/Dp1kotmo.js";import"../chunks/IHki7fMi.js";import{g as B}from"../chunks/CZYdmkq_.js";import{A as he,g as pe,v as ge,c as _e}from"../chunks/B1jZNMJx.js";import{a as ve,A as Y}from"../chunks/BDh5lRBQ.js";function Z(s,t,e){const l=s.slice();return l[15]=t[e][0],l[16]=t[e][1],l}function $(s){let t,e,l,r,a,o,c,b,n,i="Volver a Lista",m,O;function w(E,f){return E[6]&&E[7]===E[5]?we:be}let _=w(s),A=_(s);return{c(){t=T("div"),e=T("div"),l=T("span"),r=U(s[2]),a=P(),o=T("div"),c=T("button"),A.c(),b=P(),n=T("button"),n.textContent=i,this.h()},l(E){t=j(E,"DIV",{class:!0,role:!0});var f=C(t);e=j(f,"DIV",{class:!0});var u=C(e);l=j(u,"SPAN",{class:!0});var v=C(l);r=L(v,s[2]),v.forEach(p),a=V(u),o=j(u,"DIV",{class:!0});var k=C(o);c=j(k,"BUTTON",{class:!0});var y=C(c);A.l(y),y.forEach(p),b=V(k),n=j(k,"BUTTON",{class:!0,"data-svelte-h":!0}),x(n)!=="svelte-1menq0s"&&(n.textContent=i),k.forEach(p),u.forEach(p),f.forEach(p),this.h()},h(){d(l,"class","block sm:inline"),c.disabled=s[6],d(c,"class","bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm font-medium transition-colors flex items-center"),d(n,"class","bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"),d(o,"class","flex gap-2"),d(e,"class","flex justify-between items-center"),d(t,"class","bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6"),d(t,"role","alert")},m(E,f){N(E,t,f),h(t,e),h(e,l),h(l,r),h(e,a),h(e,o),h(o,c),A.m(c,null),h(o,b),h(o,n),m||(O=[K(c,"click",s[12]),K(n,"click",s[13])],m=!0)},p(E,f){f&4&&M(r,E[2]),_!==(_=w(E))&&(A.d(1),A=_(E),A&&(A.c(),A.m(c,null))),f&64&&(c.disabled=E[6])},d(E){E&&p(t),A.d(),m=!1,de(O)}}}function be(s){let t,e,l;return{c(){t=H("svg"),e=H("path"),l=U(`
                Imprimir Certificado`),this.h()},l(r){t=F(r,"svg",{xmlns:!0,class:!0,viewBox:!0,fill:!0});var a=C(t);e=F(a,"path",{"fill-rule":!0,d:!0,"clip-rule":!0}),C(e).forEach(p),a.forEach(p),l=L(r,`
                Imprimir Certificado`),this.h()},h(){d(e,"fill-rule","evenodd"),d(e,"d","M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"),d(e,"clip-rule","evenodd"),d(t,"xmlns","http://www.w3.org/2000/svg"),d(t,"class","h-4 w-4 mr-1"),d(t,"viewBox","0 0 20 20"),d(t,"fill","currentColor")},m(r,a){N(r,t,a),h(t,e),N(r,l,a)},d(r){r&&(p(t),p(l))}}}function we(s){let t,e,l,r;return{c(){t=H("svg"),e=H("circle"),l=H("path"),r=U(`
                Generando...`),this.h()},l(a){t=F(a,"svg",{class:!0,xmlns:!0,fill:!0,viewBox:!0});var o=C(t);e=F(o,"circle",{class:!0,cx:!0,cy:!0,r:!0,stroke:!0,"stroke-width":!0}),C(e).forEach(p),l=F(o,"path",{class:!0,fill:!0,d:!0}),C(l).forEach(p),o.forEach(p),r=L(a,`
                Generando...`),this.h()},h(){d(e,"class","opacity-25"),d(e,"cx","12"),d(e,"cy","12"),d(e,"r","10"),d(e,"stroke","currentColor"),d(e,"stroke-width","4"),d(l,"class","opacity-75"),d(l,"fill","currentColor"),d(l,"d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"),d(t,"class","animate-spin -ml-1 mr-2 h-4 w-4 text-white"),d(t,"xmlns","http://www.w3.org/2000/svg"),d(t,"fill","none"),d(t,"viewBox","0 0 24 24")},m(a,o){N(a,t,o),h(t,e),h(t,l),N(a,r,o)},d(a){a&&(p(t),p(r))}}}function ee(s){let t,e,l="Error:",r,a,o,c,b=Object.keys(s[4]).length>0&&!s[3].includes("validación"),n=b&&te(s);return{c(){t=T("div"),e=T("span"),e.textContent=l,r=P(),a=T("span"),o=U(s[3]),c=P(),n&&n.c(),this.h()},l(i){t=j(i,"DIV",{class:!0,role:!0});var m=C(t);e=j(m,"SPAN",{class:!0,"data-svelte-h":!0}),x(e)!=="svelte-1nq00is"&&(e.textContent=l),r=V(m),a=j(m,"SPAN",{class:!0});var O=C(a);o=L(O,s[3]),O.forEach(p),c=V(m),n&&n.l(m),m.forEach(p),this.h()},h(){d(e,"class","block sm:inline font-medium"),d(a,"class","block sm:inline"),d(t,"class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6"),d(t,"role","alert")},m(i,m){N(i,t,m),h(t,e),h(t,r),h(t,a),h(a,o),h(t,c),n&&n.m(t,null)},p(i,m){m&8&&M(o,i[3]),m&24&&(b=Object.keys(i[4]).length>0&&!i[3].includes("validación")),b?n?n.p(i,m):(n=te(i),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},d(i){i&&p(t),n&&n.d()}}}function te(s){let t,e=X(Object.entries(s[4])),l=[];for(let r=0;r<e.length;r+=1)l[r]=le(Z(s,e,r));return{c(){t=T("ul");for(let r=0;r<l.length;r+=1)l[r].c();this.h()},l(r){t=j(r,"UL",{class:!0});var a=C(t);for(let o=0;o<l.length;o+=1)l[o].l(a);a.forEach(p),this.h()},h(){d(t,"class","mt-2 list-disc list-inside")},m(r,a){N(r,t,a);for(let o=0;o<l.length;o+=1)l[o]&&l[o].m(t,null)},p(r,a){if(a&16){e=X(Object.entries(r[4]));let o;for(o=0;o<e.length;o+=1){const c=Z(r,e,o);l[o]?l[o].p(c,a):(l[o]=le(c),l[o].c(),l[o].m(t,null))}for(;o<l.length;o+=1)l[o].d(1);l.length=e.length}},d(r){r&&p(t),ue(l,r)}}}function re(s){let t,e,l=s[15]+"",r,a,o,c=s[16]+"",b;return{c(){t=T("li"),e=T("strong"),r=U(l),a=U(":"),o=P(),b=U(c)},l(n){t=j(n,"LI",{});var i=C(t);e=j(i,"STRONG",{});var m=C(e);r=L(m,l),a=L(m,":"),m.forEach(p),o=V(i),b=L(i,c),i.forEach(p)},m(n,i){N(n,t,i),h(t,e),h(e,r),h(e,a),h(t,o),h(t,b)},p(n,i){i&16&&l!==(l=n[15]+"")&&M(r,l),i&16&&c!==(c=n[16]+"")&&M(b,c)},d(n){n&&p(t)}}}function le(s){let t,e=s[16]&&re(s);return{c(){e&&e.c(),t=Q()},l(l){e&&e.l(l),t=Q()},m(l,r){e&&e.m(l,r),N(l,t,r)},p(l,r){l[16]?e?e.p(l,r):(e=re(l),e.c(),e.m(t.parentNode,t)):e&&(e.d(1),e=null)},d(l){l&&p(t),e&&e.d(l)}}}function ke(s){let t,e,l,r,a,o='<h1 class="text-2xl font-bold text-gray-800">Nuevo Avalúo</h1>',c,b,n,i,m,O;e=new me({props:{user:s[0]}});let w=s[2]&&$(s),_=s[3]&&ee(s);function A(f){s[14](f)}let E={validationErrors:s[4],isSubmitting:s[1],isEdit:!1};return s[8]!==void 0&&(E.formData=s[8]),i=new he({props:E}),se.push(()=>ie(i,"formData",A)),i.$on("submit",s[9]),i.$on("cancel",s[10]),{c(){t=T("div"),J(e.$$.fragment),l=P(),r=T("main"),a=T("div"),a.innerHTML=o,c=P(),w&&w.c(),b=P(),_&&_.c(),n=P(),J(i.$$.fragment),this.h()},l(f){t=j(f,"DIV",{class:!0});var u=C(t);W(e.$$.fragment,u),l=V(u),r=j(u,"MAIN",{class:!0});var v=C(r);a=j(v,"DIV",{class:!0,"data-svelte-h":!0}),x(a)!=="svelte-1n7a6jo"&&(a.innerHTML=o),c=V(v),w&&w.l(v),b=V(v),_&&_.l(v),n=V(v),W(i.$$.fragment,v),v.forEach(p),u.forEach(p),this.h()},h(){d(a,"class","flex justify-between items-center mb-6"),d(r,"class","max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"),d(t,"class","min-h-screen bg-gray-50")},m(f,u){N(f,t,u),q(e,t,null),h(t,l),h(t,r),h(r,a),h(r,c),w&&w.m(r,null),h(r,b),_&&_.m(r,null),h(r,n),q(i,r,null),O=!0},p(f,[u]){const v={};u&1&&(v.user=f[0]),e.$set(v),f[2]?w?w.p(f,u):(w=$(f),w.c(),w.m(r,b)):w&&(w.d(1),w=null),f[3]?_?_.p(f,u):(_=ee(f),_.c(),_.m(r,n)):_&&(_.d(1),_=null);const k={};u&16&&(k.validationErrors=f[4]),u&2&&(k.isSubmitting=f[1]),!m&&u&256&&(m=!0,k.formData=f[8],ce(()=>m=!1)),i.$set(k)},i(f){O||(G(e.$$.fragment,f),G(i.$$.fragment,f),O=!0)},o(f){R(e.$$.fragment,f),R(i.$$.fragment,f),O=!1},d(f){f&&p(t),z(e),w&&w.d(),_&&_.d(),z(i)}}}function Ee(s,t,e){let l=null,r=!1,a="",o="",c={},b=null,n=!1,i=null,m=pe();m.appraisal_date=new Date().toISOString().split("T")[0],fe(async()=>{const u=localStorage.getItem("userData");if(u)try{e(0,l=JSON.parse(u))}catch{}localStorage.getItem("jwtToken")||(e(3,o="Sesión no válida. Por favor inicie sesión nuevamente."),setTimeout(()=>B("/login"),2e3))});async function O(){var u;e(1,r=!0),e(3,o=""),e(2,a=""),e(4,c={});try{if(e(4,c=ge(m,!1)),Object.keys(c).length>0&&(e(4,c=Object.fromEntries(Object.entries(c).filter(([y,S])=>S))),Object.keys(c).length>0))throw new Error("Por favor corrija los errores de validación.");if(!localStorage.getItem("jwtToken"))throw new Error("No se encontró token de autenticación. Por favor inicie sesión nuevamente.");const k=_e(m);try{const y=await ve(Y.AVALUOS.create,{method:"POST",body:JSON.stringify(k)});e(5,b=y.id||y.vehicle_appraisal_id),e(2,a="Avalúo guardado correctamente."),e(1,r=!1)}catch(y){y.status===401?(localStorage.removeItem("jwtToken"),setTimeout(()=>B("/login"),2e3),e(3,o="Sesión expirada. Por favor inicie sesión nuevamente.")):y.status===422&&((u=y.data)!=null&&u.detail)?(e(3,o="Error de validación del servidor. Por favor revise los campos."),e(4,c={}),y.data.detail.forEach(S=>{const D=S.loc[S.loc.length-1];D&&e(4,c[D]=S.msg,c)})):e(3,o=y.message||"Error al comunicarse con el servidor.")}}catch(v){o||e(3,o=v.message||"Ha ocurrido un error al guardar el avalúo.")}finally{e(1,r=!1)}}function w(){B("/avaluos")}async function _(u){try{const v=localStorage.getItem("jwtToken");if(!v){alert("No se encontró token de autenticación. Por favor inicie sesión nuevamente."),setTimeout(()=>B("/login"),1e3);return}e(6,n=!0),e(7,i=u);const k=await fetch(Y.CERTIFICADOS.get(u),{method:"GET",headers:{Authorization:`Bearer ${v}`}});if(!k.ok)throw new Error(`Error al obtener el certificado: ${k.status} ${k.statusText}`);const y=k.headers.get("content-type");if(y&&y.includes("application/pdf")){const S=await k.blob(),D=window.URL.createObjectURL(S);try{const I=window.open(D,"_blank");if(!I||I.closed||typeof I.closed>"u"){const g=document.createElement("a");g.href=D,g.target="_blank",g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g),setTimeout(()=>{alert("El certificado se está descargando. Si no se abrió automáticamente, revisa tu carpeta de descargas.")},100)}}catch{const g=document.createElement("a");g.href=D,g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g),alert("El certificado se está descargando. Revisa tu carpeta de descargas.")}}else if(y&&y.includes("application/json")){const S=await k.json();if(S.url)try{const D=window.open(S.url,"_blank");(!D||D.closed||typeof D.closed>"u")&&(window.location.href=S.url)}catch{window.location.href=S.url}else throw new Error(S.message||"Error al generar el certificado")}else{const S=await k.blob(),D=window.URL.createObjectURL(S);try{const I=window.open(D,"_blank");if(!I||I.closed||typeof I.closed>"u"){const g=document.createElement("a");g.href=D,g.target="_blank",g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g)}}catch{const g=document.createElement("a");g.href=D,g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g)}}}catch(v){alert(`Error al obtener el certificado: ${v.message}`)}finally{e(6,n=!1),e(7,i=null)}}const A=()=>_(b),E=()=>B("/avaluos");function f(u){m=u,e(8,m)}return[l,r,a,o,c,b,n,i,m,O,w,_,A,E,f]}class Ae extends oe{constructor(t){super(),ae(this,t,Ee,ke,ne,{})}}export{Ae as component};
