import{S as re,i as le,s as ae,m as oe,o as se,d as p,p as M,q as x,r as z,u as ne,b as C,v as R,c as g,w as u,e as S,f as y,x as G,h as I,y as H,j as D,z as q,k as O,A as ie,B as ce,a as F,C as J,g as N,t as P,D as fe,E as U,F as B,G as W}from"../chunks/DH0NG5GU.js";import{N as ue,e as K}from"../chunks/BPW1MbWz.js";import"../chunks/IHki7fMi.js";import{g as L}from"../chunks/DNYyVYut.js";import{A as me,g as de,v as he,c as ge}from"../chunks/Z2UvKsFD.js";import{a as pe,A as Q}from"../chunks/bK7qKMo_.js";function X(n,t,e){const l=n.slice();return l[15]=t[e][0],l[16]=t[e][1],l}function Y(n){let t,e,l,r,o,a,c,b,s,i="Volver a Lista",m,j;function w(k,f){return k[6]&&k[7]===k[5]?_e:ve}let v=w(n),A=v(n);return{c(){t=D("div"),e=D("div"),l=D("span"),r=P(n[2]),o=O(),a=D("div"),c=D("button"),A.c(),b=O(),s=D("button"),s.textContent=i,this.h()},l(k){t=S(k,"DIV",{class:!0,role:!0});var f=y(t);e=S(f,"DIV",{class:!0});var d=y(e);l=S(d,"SPAN",{class:!0});var h=y(l);r=N(h,n[2]),h.forEach(p),o=I(d),a=S(d,"DIV",{class:!0});var _=y(a);c=S(_,"BUTTON",{class:!0});var E=y(c);A.l(E),E.forEach(p),b=I(_),s=S(_,"BUTTON",{class:!0,"data-svelte-h":!0}),H(s)!=="svelte-1menq0s"&&(s.textContent=i),_.forEach(p),d.forEach(p),f.forEach(p),this.h()},h(){u(l,"class","block sm:inline"),c.disabled=n[6],u(c,"class","bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm font-medium transition-colors flex items-center"),u(s,"class","bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"),u(a,"class","flex gap-2"),u(e,"class","flex justify-between items-center"),u(t,"class","bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6"),u(t,"role","alert")},m(k,f){C(k,t,f),g(t,e),g(e,l),g(l,r),g(e,o),g(e,a),g(a,c),A.m(c,null),g(a,b),g(a,s),m||(j=[J(c,"click",n[12]),J(s,"click",n[13])],m=!0)},p(k,f){f&4&&F(r,k[2]),v!==(v=w(k))&&(A.d(1),A=v(k),A&&(A.c(),A.m(c,null))),f&64&&(c.disabled=k[6])},d(k){k&&p(t),A.d(),m=!1,ce(j)}}}function ve(n){let t,e,l;return{c(){t=B("svg"),e=B("path"),l=P(`
                Imprimir Certificado`),this.h()},l(r){t=U(r,"svg",{xmlns:!0,class:!0,viewBox:!0,fill:!0});var o=y(t);e=U(o,"path",{"fill-rule":!0,d:!0,"clip-rule":!0}),y(e).forEach(p),o.forEach(p),l=N(r,`
                Imprimir Certificado`),this.h()},h(){u(e,"fill-rule","evenodd"),u(e,"d","M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"),u(e,"clip-rule","evenodd"),u(t,"xmlns","http://www.w3.org/2000/svg"),u(t,"class","h-4 w-4 mr-1"),u(t,"viewBox","0 0 20 20"),u(t,"fill","currentColor")},m(r,o){C(r,t,o),g(t,e),C(r,l,o)},d(r){r&&(p(t),p(l))}}}function _e(n){let t,e,l,r;return{c(){t=B("svg"),e=B("circle"),l=B("path"),r=P(`
                Generando...`),this.h()},l(o){t=U(o,"svg",{class:!0,xmlns:!0,fill:!0,viewBox:!0});var a=y(t);e=U(a,"circle",{class:!0,cx:!0,cy:!0,r:!0,stroke:!0,"stroke-width":!0}),y(e).forEach(p),l=U(a,"path",{class:!0,fill:!0,d:!0}),y(l).forEach(p),a.forEach(p),r=N(o,`
                Generando...`),this.h()},h(){u(e,"class","opacity-25"),u(e,"cx","12"),u(e,"cy","12"),u(e,"r","10"),u(e,"stroke","currentColor"),u(e,"stroke-width","4"),u(l,"class","opacity-75"),u(l,"fill","currentColor"),u(l,"d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"),u(t,"class","animate-spin -ml-1 mr-2 h-4 w-4 text-white"),u(t,"xmlns","http://www.w3.org/2000/svg"),u(t,"fill","none"),u(t,"viewBox","0 0 24 24")},m(o,a){C(o,t,a),g(t,e),g(t,l),C(o,r,a)},d(o){o&&(p(t),p(r))}}}function Z(n){let t,e,l="Error:",r,o,a,c,b=Object.keys(n[4]).length>0&&!n[3].includes("validación"),s=b&&$(n);return{c(){t=D("div"),e=D("span"),e.textContent=l,r=O(),o=D("span"),a=P(n[3]),c=O(),s&&s.c(),this.h()},l(i){t=S(i,"DIV",{class:!0,role:!0});var m=y(t);e=S(m,"SPAN",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1nq00is"&&(e.textContent=l),r=I(m),o=S(m,"SPAN",{class:!0});var j=y(o);a=N(j,n[3]),j.forEach(p),c=I(m),s&&s.l(m),m.forEach(p),this.h()},h(){u(e,"class","block sm:inline font-medium"),u(o,"class","block sm:inline"),u(t,"class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6"),u(t,"role","alert")},m(i,m){C(i,t,m),g(t,e),g(t,r),g(t,o),g(o,a),g(t,c),s&&s.m(t,null)},p(i,m){m&8&&F(a,i[3]),m&24&&(b=Object.keys(i[4]).length>0&&!i[3].includes("validación")),b?s?s.p(i,m):(s=$(i),s.c(),s.m(t,null)):s&&(s.d(1),s=null)},d(i){i&&p(t),s&&s.d()}}}function $(n){let t,e=K(Object.entries(n[4])),l=[];for(let r=0;r<e.length;r+=1)l[r]=te(X(n,e,r));return{c(){t=D("ul");for(let r=0;r<l.length;r+=1)l[r].c();this.h()},l(r){t=S(r,"UL",{class:!0});var o=y(t);for(let a=0;a<l.length;a+=1)l[a].l(o);o.forEach(p),this.h()},h(){u(t,"class","mt-2 list-disc list-inside")},m(r,o){C(r,t,o);for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(t,null)},p(r,o){if(o&16){e=K(Object.entries(r[4]));let a;for(a=0;a<e.length;a+=1){const c=X(r,e,a);l[a]?l[a].p(c,o):(l[a]=te(c),l[a].c(),l[a].m(t,null))}for(;a<l.length;a+=1)l[a].d(1);l.length=e.length}},d(r){r&&p(t),fe(l,r)}}}function ee(n){let t,e,l=n[15]+"",r,o,a,c=n[16]+"",b;return{c(){t=D("li"),e=D("strong"),r=P(l),o=P(":"),a=O(),b=P(c)},l(s){t=S(s,"LI",{});var i=y(t);e=S(i,"STRONG",{});var m=y(e);r=N(m,l),o=N(m,":"),m.forEach(p),a=I(i),b=N(i,c),i.forEach(p)},m(s,i){C(s,t,i),g(t,e),g(e,r),g(e,o),g(t,a),g(t,b)},p(s,i){i&16&&l!==(l=s[15]+"")&&F(r,l),i&16&&c!==(c=s[16]+"")&&F(b,c)},d(s){s&&p(t)}}}function te(n){let t,e=n[16]&&ee(n);return{c(){e&&e.c(),t=W()},l(l){e&&e.l(l),t=W()},m(l,r){e&&e.m(l,r),C(l,t,r)},p(l,r){l[16]?e?e.p(l,r):(e=ee(l),e.c(),e.m(t.parentNode,t)):e&&(e.d(1),e=null)},d(l){l&&p(t),e&&e.d(l)}}}function be(n){let t,e,l,r,o,a='<h1 class="text-2xl font-bold text-gray-800">Nuevo Avalúo</h1>',c,b,s,i,m,j;e=new ue({props:{user:n[0]}});let w=n[2]&&Y(n),v=n[3]&&Z(n);function A(f){n[14](f)}let k={validationErrors:n[4],isSubmitting:n[1],isEdit:!1};return n[8]!==void 0&&(k.formData=n[8]),i=new me({props:k}),oe.push(()=>se(i,"formData",A)),i.$on("submit",n[9]),i.$on("cancel",n[10]),{c(){t=D("div"),q(e.$$.fragment),l=O(),r=D("main"),o=D("div"),o.innerHTML=a,c=O(),w&&w.c(),b=O(),v&&v.c(),s=O(),q(i.$$.fragment),this.h()},l(f){t=S(f,"DIV",{class:!0});var d=y(t);G(e.$$.fragment,d),l=I(d),r=S(d,"MAIN",{class:!0});var h=y(r);o=S(h,"DIV",{class:!0,"data-svelte-h":!0}),H(o)!=="svelte-1n7a6jo"&&(o.innerHTML=a),c=I(h),w&&w.l(h),b=I(h),v&&v.l(h),s=I(h),G(i.$$.fragment,h),h.forEach(p),d.forEach(p),this.h()},h(){u(o,"class","flex justify-between items-center mb-6"),u(r,"class","max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"),u(t,"class","min-h-screen bg-gray-50")},m(f,d){C(f,t,d),R(e,t,null),g(t,l),g(t,r),g(r,o),g(r,c),w&&w.m(r,null),g(r,b),v&&v.m(r,null),g(r,s),R(i,r,null),j=!0},p(f,[d]){const h={};d&1&&(h.user=f[0]),e.$set(h),f[2]?w?w.p(f,d):(w=Y(f),w.c(),w.m(r,b)):w&&(w.d(1),w=null),f[3]?v?v.p(f,d):(v=Z(f),v.c(),v.m(r,s)):v&&(v.d(1),v=null);const _={};d&16&&(_.validationErrors=f[4]),d&2&&(_.isSubmitting=f[1]),!m&&d&256&&(m=!0,_.formData=f[8],ne(()=>m=!1)),i.$set(_)},i(f){j||(z(e.$$.fragment,f),z(i.$$.fragment,f),j=!0)},o(f){x(e.$$.fragment,f),x(i.$$.fragment,f),j=!1},d(f){f&&p(t),M(e),w&&w.d(),v&&v.d(),M(i)}}}function we(n,t,e){let l=null,r=!1,o="",a="",c={},b=null,s=!1,i=null,m=de();m.appraisal_date=new Date().toISOString().split("T")[0],ie(async()=>{const d=localStorage.getItem("userData");if(d)try{e(0,l=JSON.parse(d))}catch(_){console.error("Error parsing user data:",_)}const h=localStorage.getItem("jwtToken");h?console.log("Token value:",h.substring(0,20)+"..."):(console.warn("No se encontró token JWT en localStorage"),e(3,a="Sesión no válida. Por favor inicie sesión nuevamente."),setTimeout(()=>L("/login"),2e3))});async function j(){var d;e(1,r=!0),e(3,a=""),e(2,o=""),e(4,c={});try{if(e(4,c=he(m)),Object.keys(c).length>0&&(e(4,c=Object.fromEntries(Object.entries(c).filter(([E,T])=>T))),Object.keys(c).length>0))throw new Error("Por favor corrija los errores de validación.");if(!localStorage.getItem("jwtToken"))throw new Error("No se encontró token de autenticación. Por favor inicie sesión nuevamente.");const _=ge(m);console.log("Datos enviados al API (Nuevo):",JSON.stringify(_,null,2));try{const E=await pe(Q.AVALUOS.create,{method:"POST",body:JSON.stringify(_)});e(5,b=E.id||E.vehicle_appraisal_id),e(2,o="Avalúo guardado correctamente."),e(1,r=!1)}catch(E){console.error("API Error:",E),E.status===401?(localStorage.removeItem("jwtToken"),setTimeout(()=>L("/login"),2e3),e(3,a="Sesión expirada. Por favor inicie sesión nuevamente.")):E.status===422&&((d=E.data)!=null&&d.detail)?(e(3,a="Error de validación del servidor. Por favor revise los campos."),e(4,c={}),E.data.detail.forEach(T=>{const V=T.loc[T.loc.length-1];V&&e(4,c[V]=T.msg,c)})):e(3,a=E.message||"Error al comunicarse con el servidor.")}}catch(h){console.error("Error submitting form:",h),a||e(3,a=h.message||"Ha ocurrido un error al guardar el avalúo.")}finally{e(1,r=!1)}}function w(){L("/avaluos")}async function v(d){try{const h=localStorage.getItem("jwtToken");if(!h){alert("No se encontró token de autenticación. Por favor inicie sesión nuevamente."),setTimeout(()=>L("/login"),1e3);return}e(6,s=!0),e(7,i=d);const _=await fetch(Q.CERTIFICADOS.get(d),{method:"GET",headers:{Authorization:`Bearer ${h}`}});if(!_.ok)throw new Error(`Error al obtener el certificado: ${_.status} ${_.statusText}`);const E=_.headers.get("content-type");if(E&&E.includes("application/pdf")){const T=await _.blob(),V=window.URL.createObjectURL(T);window.open(V,"_blank")}else if(E&&E.includes("application/json")){const T=await _.json();if(T.url)window.open(T.url,"_blank");else throw new Error(T.message||"Error al generar el certificado")}else{const T=await _.blob(),V=window.URL.createObjectURL(T);window.open(V,"_blank")}}catch(h){console.error("Error al obtener el certificado:",h),alert(`Error al obtener el certificado: ${h.message}`)}finally{e(6,s=!1),e(7,i=null)}}const A=()=>v(b),k=()=>L("/avaluos");function f(d){m=d,e(8,m)}return[l,r,o,a,c,b,s,i,m,j,w,v,A,k,f]}class Te extends re{constructor(t){super(),le(this,t,we,be,ae,{})}}export{Te as component};
