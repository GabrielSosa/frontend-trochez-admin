import{S as ne,i as se,s as ie,m as ce,o as fe,d as p,p as z,q as R,r as G,u as de,b as I,v as q,c as h,w as d,e as j,f as C,x as W,h as V,y as x,j as T,z as J,k as P,A as ue,B as me,a as M,C as K,g as L,t as U,D as he,E as F,F as H,G as Q}from"../chunks/CnbjcvQe.js";import{N as pe,e as X}from"../chunks/Bs4VbhQe.js";import"../chunks/IHki7fMi.js";import{g as B}from"../chunks/DA3rruqa.js";import{A as ge,g as _e,v as ve,c as be}from"../chunks/aXCXkANC.js";import{a as we,A as Y}from"../chunks/BDh5lRBQ.js";import{c as ke,s as Z,a as $}from"../chunks/DfOTljOW.js";function ee(s,t,e){const o=s.slice();return o[15]=t[e][0],o[16]=t[e][1],o}function te(s){let t,e,o,r,l,a,c,b,n,i="Volver a Lista",m,O;function w(E,f){return E[6]&&E[7]===E[5]?ye:Ee}let _=w(s),A=_(s);return{c(){t=T("div"),e=T("div"),o=T("span"),r=U(s[2]),l=P(),a=T("div"),c=T("button"),A.c(),b=P(),n=T("button"),n.textContent=i,this.h()},l(E){t=j(E,"DIV",{class:!0,role:!0});var f=C(t);e=j(f,"DIV",{class:!0});var u=C(e);o=j(u,"SPAN",{class:!0});var v=C(o);r=L(v,s[2]),v.forEach(p),l=V(u),a=j(u,"DIV",{class:!0});var k=C(a);c=j(k,"BUTTON",{class:!0});var y=C(c);A.l(y),y.forEach(p),b=V(k),n=j(k,"BUTTON",{class:!0,"data-svelte-h":!0}),x(n)!=="svelte-1menq0s"&&(n.textContent=i),k.forEach(p),u.forEach(p),f.forEach(p),this.h()},h(){d(o,"class","block sm:inline"),c.disabled=s[6],d(c,"class","bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm font-medium transition-colors flex items-center"),d(n,"class","bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"),d(a,"class","flex gap-2"),d(e,"class","flex justify-between items-center"),d(t,"class","bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6"),d(t,"role","alert")},m(E,f){I(E,t,f),h(t,e),h(e,o),h(o,r),h(e,l),h(e,a),h(a,c),A.m(c,null),h(a,b),h(a,n),m||(O=[K(c,"click",s[12]),K(n,"click",s[13])],m=!0)},p(E,f){f&4&&M(r,E[2]),_!==(_=w(E))&&(A.d(1),A=_(E),A&&(A.c(),A.m(c,null))),f&64&&(c.disabled=E[6])},d(E){E&&p(t),A.d(),m=!1,me(O)}}}function Ee(s){let t,e,o;return{c(){t=H("svg"),e=H("path"),o=U(`
                Imprimir Certificado`),this.h()},l(r){t=F(r,"svg",{xmlns:!0,class:!0,viewBox:!0,fill:!0});var l=C(t);e=F(l,"path",{"fill-rule":!0,d:!0,"clip-rule":!0}),C(e).forEach(p),l.forEach(p),o=L(r,`
                Imprimir Certificado`),this.h()},h(){d(e,"fill-rule","evenodd"),d(e,"d","M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"),d(e,"clip-rule","evenodd"),d(t,"xmlns","http://www.w3.org/2000/svg"),d(t,"class","h-4 w-4 mr-1"),d(t,"viewBox","0 0 20 20"),d(t,"fill","currentColor")},m(r,l){I(r,t,l),h(t,e),I(r,o,l)},d(r){r&&(p(t),p(o))}}}function ye(s){let t,e,o,r;return{c(){t=H("svg"),e=H("circle"),o=H("path"),r=U(`
                Generando...`),this.h()},l(l){t=F(l,"svg",{class:!0,xmlns:!0,fill:!0,viewBox:!0});var a=C(t);e=F(a,"circle",{class:!0,cx:!0,cy:!0,r:!0,stroke:!0,"stroke-width":!0}),C(e).forEach(p),o=F(a,"path",{class:!0,fill:!0,d:!0}),C(o).forEach(p),a.forEach(p),r=L(l,`
                Generando...`),this.h()},h(){d(e,"class","opacity-25"),d(e,"cx","12"),d(e,"cy","12"),d(e,"r","10"),d(e,"stroke","currentColor"),d(e,"stroke-width","4"),d(o,"class","opacity-75"),d(o,"fill","currentColor"),d(o,"d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"),d(t,"class","animate-spin -ml-1 mr-2 h-4 w-4 text-white"),d(t,"xmlns","http://www.w3.org/2000/svg"),d(t,"fill","none"),d(t,"viewBox","0 0 24 24")},m(l,a){I(l,t,a),h(t,e),h(t,o),I(l,r,a)},d(l){l&&(p(t),p(r))}}}function re(s){let t,e,o="Error:",r,l,a,c,b=Object.keys(s[4]).length>0&&!s[3].includes("validación"),n=b&&oe(s);return{c(){t=T("div"),e=T("span"),e.textContent=o,r=P(),l=T("span"),a=U(s[3]),c=P(),n&&n.c(),this.h()},l(i){t=j(i,"DIV",{class:!0,role:!0});var m=C(t);e=j(m,"SPAN",{class:!0,"data-svelte-h":!0}),x(e)!=="svelte-1nq00is"&&(e.textContent=o),r=V(m),l=j(m,"SPAN",{class:!0});var O=C(l);a=L(O,s[3]),O.forEach(p),c=V(m),n&&n.l(m),m.forEach(p),this.h()},h(){d(e,"class","block sm:inline font-medium"),d(l,"class","block sm:inline"),d(t,"class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6"),d(t,"role","alert")},m(i,m){I(i,t,m),h(t,e),h(t,r),h(t,l),h(l,a),h(t,c),n&&n.m(t,null)},p(i,m){m&8&&M(a,i[3]),m&24&&(b=Object.keys(i[4]).length>0&&!i[3].includes("validación")),b?n?n.p(i,m):(n=oe(i),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},d(i){i&&p(t),n&&n.d()}}}function oe(s){let t,e=X(Object.entries(s[4])),o=[];for(let r=0;r<e.length;r+=1)o[r]=le(ee(s,e,r));return{c(){t=T("ul");for(let r=0;r<o.length;r+=1)o[r].c();this.h()},l(r){t=j(r,"UL",{class:!0});var l=C(t);for(let a=0;a<o.length;a+=1)o[a].l(l);l.forEach(p),this.h()},h(){d(t,"class","mt-2 list-disc list-inside")},m(r,l){I(r,t,l);for(let a=0;a<o.length;a+=1)o[a]&&o[a].m(t,null)},p(r,l){if(l&16){e=X(Object.entries(r[4]));let a;for(a=0;a<e.length;a+=1){const c=ee(r,e,a);o[a]?o[a].p(c,l):(o[a]=le(c),o[a].c(),o[a].m(t,null))}for(;a<o.length;a+=1)o[a].d(1);o.length=e.length}},d(r){r&&p(t),he(o,r)}}}function ae(s){let t,e,o=s[15]+"",r,l,a,c=s[16]+"",b;return{c(){t=T("li"),e=T("strong"),r=U(o),l=U(":"),a=P(),b=U(c)},l(n){t=j(n,"LI",{});var i=C(t);e=j(i,"STRONG",{});var m=C(e);r=L(m,o),l=L(m,":"),m.forEach(p),a=V(i),b=L(i,c),i.forEach(p)},m(n,i){I(n,t,i),h(t,e),h(e,r),h(e,l),h(t,a),h(t,b)},p(n,i){i&16&&o!==(o=n[15]+"")&&M(r,o),i&16&&c!==(c=n[16]+"")&&M(b,c)},d(n){n&&p(t)}}}function le(s){let t,e=s[16]&&ae(s);return{c(){e&&e.c(),t=Q()},l(o){e&&e.l(o),t=Q()},m(o,r){e&&e.m(o,r),I(o,t,r)},p(o,r){o[16]?e?e.p(o,r):(e=ae(o),e.c(),e.m(t.parentNode,t)):e&&(e.d(1),e=null)},d(o){o&&p(t),e&&e.d(o)}}}function Ce(s){let t,e,o,r,l,a='<h1 class="text-2xl font-bold text-gray-800">Nuevo Avalúo</h1>',c,b,n,i,m,O;e=new pe({props:{user:s[0]}});let w=s[2]&&te(s),_=s[3]&&re(s);function A(f){s[14](f)}let E={validationErrors:s[4],isSubmitting:s[1],isEdit:!1};return s[8]!==void 0&&(E.formData=s[8]),i=new ge({props:E}),ce.push(()=>fe(i,"formData",A)),i.$on("submit",s[9]),i.$on("cancel",s[10]),{c(){t=T("div"),J(e.$$.fragment),o=P(),r=T("main"),l=T("div"),l.innerHTML=a,c=P(),w&&w.c(),b=P(),_&&_.c(),n=P(),J(i.$$.fragment),this.h()},l(f){t=j(f,"DIV",{class:!0});var u=C(t);W(e.$$.fragment,u),o=V(u),r=j(u,"MAIN",{class:!0});var v=C(r);l=j(v,"DIV",{class:!0,"data-svelte-h":!0}),x(l)!=="svelte-1n7a6jo"&&(l.innerHTML=a),c=V(v),w&&w.l(v),b=V(v),_&&_.l(v),n=V(v),W(i.$$.fragment,v),v.forEach(p),u.forEach(p),this.h()},h(){d(l,"class","flex justify-between items-center mb-6"),d(r,"class","max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"),d(t,"class","min-h-screen bg-gray-50")},m(f,u){I(f,t,u),q(e,t,null),h(t,o),h(t,r),h(r,l),h(r,c),w&&w.m(r,null),h(r,b),_&&_.m(r,null),h(r,n),q(i,r,null),O=!0},p(f,[u]){const v={};u&1&&(v.user=f[0]),e.$set(v),f[2]?w?w.p(f,u):(w=te(f),w.c(),w.m(r,b)):w&&(w.d(1),w=null),f[3]?_?_.p(f,u):(_=re(f),_.c(),_.m(r,n)):_&&(_.d(1),_=null);const k={};u&16&&(k.validationErrors=f[4]),u&2&&(k.isSubmitting=f[1]),!m&&u&256&&(m=!0,k.formData=f[8],de(()=>m=!1)),i.$set(k)},i(f){O||(G(e.$$.fragment,f),G(i.$$.fragment,f),O=!0)},o(f){R(e.$$.fragment,f),R(i.$$.fragment,f),O=!1},d(f){f&&p(t),z(e),w&&w.d(),_&&_.d(),z(i)}}}function Se(s,t,e){let o=null,r=!1,l="",a="",c={},b=null,n=!1,i=null,m=_e();m.appraisal_date=new Date().toISOString().split("T")[0],ue(async()=>{const u=localStorage.getItem("userData");if(u)try{e(0,o=JSON.parse(u))}catch{}localStorage.getItem("jwtToken")||(e(3,a="Sesión no válida. Por favor inicie sesión nuevamente."),setTimeout(()=>B("/login"),2e3))});async function O(){var u;e(1,r=!0),e(3,a=""),e(2,l=""),e(4,c={});try{if(e(4,c=ve(m,!1)),Object.keys(c).length>0&&(e(4,c=Object.fromEntries(Object.entries(c).filter(([y,S])=>S))),Object.keys(c).length>0))throw new Error("Por favor corrija los errores de validación.");if(!localStorage.getItem("jwtToken"))throw new Error("No se encontró token de autenticación. Por favor inicie sesión nuevamente.");const k=be(m);try{const y=await we(Y.AVALUOS.create,{method:"POST",body:JSON.stringify(k)});e(5,b=y.id||y.vehicle_appraisal_id),e(2,l="Avalúo guardado correctamente."),e(1,r=!1)}catch(y){y.status===401?(localStorage.removeItem("jwtToken"),setTimeout(()=>B("/login"),2e3),e(3,a="Sesión expirada. Por favor inicie sesión nuevamente.")):y.status===422&&((u=y.data)!=null&&u.detail)?(e(3,a="Error de validación del servidor. Por favor revise los campos."),e(4,c={}),y.data.detail.forEach(S=>{const D=S.loc[S.loc.length-1];D&&e(4,c[D]=S.msg,c)})):e(3,a=y.message||"Error al comunicarse con el servidor.")}}catch(v){a||e(3,a=v.message||"Ha ocurrido un error al guardar el avalúo.")}finally{e(1,r=!1)}}async function w(){await ke()&&B("/avaluos")}async function _(u){try{const v=localStorage.getItem("jwtToken");if(!v){Z("No se encontró token de autenticación. Por favor inicie sesión nuevamente."),setTimeout(()=>B("/login"),1e3);return}e(6,n=!0),e(7,i=u);const k=await fetch(Y.CERTIFICADOS.get(u),{method:"GET",headers:{Authorization:`Bearer ${v}`}});if(!k.ok)throw new Error(`Error al obtener el certificado: ${k.status} ${k.statusText}`);const y=k.headers.get("content-type");if(y&&y.includes("application/pdf")){const S=await k.blob(),D=window.URL.createObjectURL(S);try{const N=window.open(D,"_blank");if(!N||N.closed||typeof N.closed>"u"){const g=document.createElement("a");g.href=D,g.target="_blank",g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g),setTimeout(()=>{$("El certificado se está descargando. Si no se abrió automáticamente, revisa tu carpeta de descargas.")},100)}}catch{const g=document.createElement("a");g.href=D,g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g),$("El certificado se está descargando. Revisa tu carpeta de descargas.")}}else if(y&&y.includes("application/json")){const S=await k.json();if(S.url)try{const D=window.open(S.url,"_blank");(!D||D.closed||typeof D.closed>"u")&&(window.location.href=S.url)}catch{window.location.href=S.url}else throw new Error(S.message||"Error al generar el certificado")}else{const S=await k.blob(),D=window.URL.createObjectURL(S);try{const N=window.open(D,"_blank");if(!N||N.closed||typeof N.closed>"u"){const g=document.createElement("a");g.href=D,g.target="_blank",g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g)}}catch{const g=document.createElement("a");g.href=D,g.download=`certificado_${u}.pdf`,document.body.appendChild(g),g.click(),document.body.removeChild(g)}}}catch(v){Z(`Error al obtener el certificado: ${v.message}`)}finally{e(6,n=!1),e(7,i=null)}}const A=()=>_(b),E=()=>B("/avaluos");function f(u){m=u,e(8,m)}return[o,r,l,a,c,b,n,i,m,O,w,_,A,E,f]}class Ve extends ne{constructor(t){super(),se(this,t,Se,Ce,ie,{})}}export{Ve as component};
