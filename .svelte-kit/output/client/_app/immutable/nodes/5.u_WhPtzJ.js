import{S as re,i as le,s as ae,m as se,o as ne,d as p,p as M,q as x,r as z,u as oe,b as T,v as R,c as h,w as u,e as S,f as y,x as G,h as I,y as H,j as D,z as q,k as O,A as ie,B as ce,a as F,C as J,g as N,t as V,D as fe,E as U,F as B,G as K}from"../chunks/DH0NG5GU.js";import{N as ue,e as Q}from"../chunks/x5rVgxpL.js";import"../chunks/IHki7fMi.js";import{g as L}from"../chunks/Bpwd1lxs.js";import{A as me,g as de,v as he,c as pe}from"../chunks/D32gEAv5.js";import{a as ge,A as W}from"../chunks/BDh5lRBQ.js";function X(o,t,e){const l=o.slice();return l[15]=t[e][0],l[16]=t[e][1],l}function Y(o){let t,e,l,r,s,a,c,v,n,i="Volver a Lista",m,A;function b(k,f){return k[6]&&k[7]===k[5]?ve:_e}let g=b(o),j=g(o);return{c(){t=D("div"),e=D("div"),l=D("span"),r=V(o[2]),s=O(),a=D("div"),c=D("button"),j.c(),v=O(),n=D("button"),n.textContent=i,this.h()},l(k){t=S(k,"DIV",{class:!0,role:!0});var f=y(t);e=S(f,"DIV",{class:!0});var d=y(e);l=S(d,"SPAN",{class:!0});var _=y(l);r=N(_,o[2]),_.forEach(p),s=I(d),a=S(d,"DIV",{class:!0});var w=y(a);c=S(w,"BUTTON",{class:!0});var E=y(c);j.l(E),E.forEach(p),v=I(w),n=S(w,"BUTTON",{class:!0,"data-svelte-h":!0}),H(n)!=="svelte-1menq0s"&&(n.textContent=i),w.forEach(p),d.forEach(p),f.forEach(p),this.h()},h(){u(l,"class","block sm:inline"),c.disabled=o[6],u(c,"class","bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-1 rounded text-sm font-medium transition-colors flex items-center"),u(n,"class","bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"),u(a,"class","flex gap-2"),u(e,"class","flex justify-between items-center"),u(t,"class","bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6"),u(t,"role","alert")},m(k,f){T(k,t,f),h(t,e),h(e,l),h(l,r),h(e,s),h(e,a),h(a,c),j.m(c,null),h(a,v),h(a,n),m||(A=[J(c,"click",o[12]),J(n,"click",o[13])],m=!0)},p(k,f){f&4&&F(r,k[2]),g!==(g=b(k))&&(j.d(1),j=g(k),j&&(j.c(),j.m(c,null))),f&64&&(c.disabled=k[6])},d(k){k&&p(t),j.d(),m=!1,ce(A)}}}function _e(o){let t,e,l;return{c(){t=B("svg"),e=B("path"),l=V(`
                Imprimir Certificado`),this.h()},l(r){t=U(r,"svg",{xmlns:!0,class:!0,viewBox:!0,fill:!0});var s=y(t);e=U(s,"path",{"fill-rule":!0,d:!0,"clip-rule":!0}),y(e).forEach(p),s.forEach(p),l=N(r,`
                Imprimir Certificado`),this.h()},h(){u(e,"fill-rule","evenodd"),u(e,"d","M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"),u(e,"clip-rule","evenodd"),u(t,"xmlns","http://www.w3.org/2000/svg"),u(t,"class","h-4 w-4 mr-1"),u(t,"viewBox","0 0 20 20"),u(t,"fill","currentColor")},m(r,s){T(r,t,s),h(t,e),T(r,l,s)},d(r){r&&(p(t),p(l))}}}function ve(o){let t,e,l,r;return{c(){t=B("svg"),e=B("circle"),l=B("path"),r=V(`
                Generando...`),this.h()},l(s){t=U(s,"svg",{class:!0,xmlns:!0,fill:!0,viewBox:!0});var a=y(t);e=U(a,"circle",{class:!0,cx:!0,cy:!0,r:!0,stroke:!0,"stroke-width":!0}),y(e).forEach(p),l=U(a,"path",{class:!0,fill:!0,d:!0}),y(l).forEach(p),a.forEach(p),r=N(s,`
                Generando...`),this.h()},h(){u(e,"class","opacity-25"),u(e,"cx","12"),u(e,"cy","12"),u(e,"r","10"),u(e,"stroke","currentColor"),u(e,"stroke-width","4"),u(l,"class","opacity-75"),u(l,"fill","currentColor"),u(l,"d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"),u(t,"class","animate-spin -ml-1 mr-2 h-4 w-4 text-white"),u(t,"xmlns","http://www.w3.org/2000/svg"),u(t,"fill","none"),u(t,"viewBox","0 0 24 24")},m(s,a){T(s,t,a),h(t,e),h(t,l),T(s,r,a)},d(s){s&&(p(t),p(r))}}}function Z(o){let t,e,l="Error:",r,s,a,c,v=Object.keys(o[4]).length>0&&!o[3].includes("validación"),n=v&&$(o);return{c(){t=D("div"),e=D("span"),e.textContent=l,r=O(),s=D("span"),a=V(o[3]),c=O(),n&&n.c(),this.h()},l(i){t=S(i,"DIV",{class:!0,role:!0});var m=y(t);e=S(m,"SPAN",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1nq00is"&&(e.textContent=l),r=I(m),s=S(m,"SPAN",{class:!0});var A=y(s);a=N(A,o[3]),A.forEach(p),c=I(m),n&&n.l(m),m.forEach(p),this.h()},h(){u(e,"class","block sm:inline font-medium"),u(s,"class","block sm:inline"),u(t,"class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6"),u(t,"role","alert")},m(i,m){T(i,t,m),h(t,e),h(t,r),h(t,s),h(s,a),h(t,c),n&&n.m(t,null)},p(i,m){m&8&&F(a,i[3]),m&24&&(v=Object.keys(i[4]).length>0&&!i[3].includes("validación")),v?n?n.p(i,m):(n=$(i),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},d(i){i&&p(t),n&&n.d()}}}function $(o){let t,e=Q(Object.entries(o[4])),l=[];for(let r=0;r<e.length;r+=1)l[r]=te(X(o,e,r));return{c(){t=D("ul");for(let r=0;r<l.length;r+=1)l[r].c();this.h()},l(r){t=S(r,"UL",{class:!0});var s=y(t);for(let a=0;a<l.length;a+=1)l[a].l(s);s.forEach(p),this.h()},h(){u(t,"class","mt-2 list-disc list-inside")},m(r,s){T(r,t,s);for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(t,null)},p(r,s){if(s&16){e=Q(Object.entries(r[4]));let a;for(a=0;a<e.length;a+=1){const c=X(r,e,a);l[a]?l[a].p(c,s):(l[a]=te(c),l[a].c(),l[a].m(t,null))}for(;a<l.length;a+=1)l[a].d(1);l.length=e.length}},d(r){r&&p(t),fe(l,r)}}}function ee(o){let t,e,l=o[15]+"",r,s,a,c=o[16]+"",v;return{c(){t=D("li"),e=D("strong"),r=V(l),s=V(":"),a=O(),v=V(c)},l(n){t=S(n,"LI",{});var i=y(t);e=S(i,"STRONG",{});var m=y(e);r=N(m,l),s=N(m,":"),m.forEach(p),a=I(i),v=N(i,c),i.forEach(p)},m(n,i){T(n,t,i),h(t,e),h(e,r),h(e,s),h(t,a),h(t,v)},p(n,i){i&16&&l!==(l=n[15]+"")&&F(r,l),i&16&&c!==(c=n[16]+"")&&F(v,c)},d(n){n&&p(t)}}}function te(o){let t,e=o[16]&&ee(o);return{c(){e&&e.c(),t=K()},l(l){e&&e.l(l),t=K()},m(l,r){e&&e.m(l,r),T(l,t,r)},p(l,r){l[16]?e?e.p(l,r):(e=ee(l),e.c(),e.m(t.parentNode,t)):e&&(e.d(1),e=null)},d(l){l&&p(t),e&&e.d(l)}}}function be(o){let t,e,l,r,s,a='<h1 class="text-2xl font-bold text-gray-800">Nuevo Avalúo</h1>',c,v,n,i,m,A;e=new ue({props:{user:o[0]}});let b=o[2]&&Y(o),g=o[3]&&Z(o);function j(f){o[14](f)}let k={validationErrors:o[4],isSubmitting:o[1],isEdit:!1};return o[8]!==void 0&&(k.formData=o[8]),i=new me({props:k}),se.push(()=>ne(i,"formData",j)),i.$on("submit",o[9]),i.$on("cancel",o[10]),{c(){t=D("div"),q(e.$$.fragment),l=O(),r=D("main"),s=D("div"),s.innerHTML=a,c=O(),b&&b.c(),v=O(),g&&g.c(),n=O(),q(i.$$.fragment),this.h()},l(f){t=S(f,"DIV",{class:!0});var d=y(t);G(e.$$.fragment,d),l=I(d),r=S(d,"MAIN",{class:!0});var _=y(r);s=S(_,"DIV",{class:!0,"data-svelte-h":!0}),H(s)!=="svelte-1n7a6jo"&&(s.innerHTML=a),c=I(_),b&&b.l(_),v=I(_),g&&g.l(_),n=I(_),G(i.$$.fragment,_),_.forEach(p),d.forEach(p),this.h()},h(){u(s,"class","flex justify-between items-center mb-6"),u(r,"class","max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"),u(t,"class","min-h-screen bg-gray-50")},m(f,d){T(f,t,d),R(e,t,null),h(t,l),h(t,r),h(r,s),h(r,c),b&&b.m(r,null),h(r,v),g&&g.m(r,null),h(r,n),R(i,r,null),A=!0},p(f,[d]){const _={};d&1&&(_.user=f[0]),e.$set(_),f[2]?b?b.p(f,d):(b=Y(f),b.c(),b.m(r,v)):b&&(b.d(1),b=null),f[3]?g?g.p(f,d):(g=Z(f),g.c(),g.m(r,n)):g&&(g.d(1),g=null);const w={};d&16&&(w.validationErrors=f[4]),d&2&&(w.isSubmitting=f[1]),!m&&d&256&&(m=!0,w.formData=f[8],oe(()=>m=!1)),i.$set(w)},i(f){A||(z(e.$$.fragment,f),z(i.$$.fragment,f),A=!0)},o(f){x(e.$$.fragment,f),x(i.$$.fragment,f),A=!1},d(f){f&&p(t),M(e),b&&b.d(),g&&g.d(),M(i)}}}function we(o,t,e){let l=null,r=!1,s="",a="",c={},v=null,n=!1,i=null,m=de();m.appraisal_date=new Date().toISOString().split("T")[0],ie(async()=>{const d=localStorage.getItem("userData");if(d)try{e(0,l=JSON.parse(d))}catch{}localStorage.getItem("jwtToken")||(e(3,a="Sesión no válida. Por favor inicie sesión nuevamente."),setTimeout(()=>L("/login"),2e3))});async function A(){var d;e(1,r=!0),e(3,a=""),e(2,s=""),e(4,c={});try{if(e(4,c=he(m,!1)),Object.keys(c).length>0&&(e(4,c=Object.fromEntries(Object.entries(c).filter(([E,C])=>C))),Object.keys(c).length>0))throw new Error("Por favor corrija los errores de validación.");if(!localStorage.getItem("jwtToken"))throw new Error("No se encontró token de autenticación. Por favor inicie sesión nuevamente.");const w=pe(m);try{const E=await ge(W.AVALUOS.create,{method:"POST",body:JSON.stringify(w)});e(5,v=E.id||E.vehicle_appraisal_id),e(2,s="Avalúo guardado correctamente."),e(1,r=!1)}catch(E){E.status===401?(localStorage.removeItem("jwtToken"),setTimeout(()=>L("/login"),2e3),e(3,a="Sesión expirada. Por favor inicie sesión nuevamente.")):E.status===422&&((d=E.data)!=null&&d.detail)?(e(3,a="Error de validación del servidor. Por favor revise los campos."),e(4,c={}),E.data.detail.forEach(C=>{const P=C.loc[C.loc.length-1];P&&e(4,c[P]=C.msg,c)})):e(3,a=E.message||"Error al comunicarse con el servidor.")}}catch(_){a||e(3,a=_.message||"Ha ocurrido un error al guardar el avalúo.")}finally{e(1,r=!1)}}function b(){L("/avaluos")}async function g(d){try{const _=localStorage.getItem("jwtToken");if(!_){alert("No se encontró token de autenticación. Por favor inicie sesión nuevamente."),setTimeout(()=>L("/login"),1e3);return}e(6,n=!0),e(7,i=d);const w=await fetch(W.CERTIFICADOS.get(d),{method:"GET",headers:{Authorization:`Bearer ${_}`}});if(!w.ok)throw new Error(`Error al obtener el certificado: ${w.status} ${w.statusText}`);const E=w.headers.get("content-type");if(E&&E.includes("application/pdf")){const C=await w.blob(),P=window.URL.createObjectURL(C);window.open(P,"_blank")}else if(E&&E.includes("application/json")){const C=await w.json();if(C.url)window.open(C.url,"_blank");else throw new Error(C.message||"Error al generar el certificado")}else{const C=await w.blob(),P=window.URL.createObjectURL(C);window.open(P,"_blank")}}catch(_){alert(`Error al obtener el certificado: ${_.message}`)}finally{e(6,n=!1),e(7,i=null)}}const j=()=>g(v),k=()=>L("/avaluos");function f(d){m=d,e(8,m)}return[l,r,s,a,c,v,n,i,m,A,b,g,j,k,f]}class Ce extends re{constructor(t){super(),le(this,t,we,be,ae,{})}}export{Ce as component};
